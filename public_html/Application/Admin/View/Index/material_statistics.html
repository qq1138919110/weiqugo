<include file="public:header"/>

    <!-- Sidebar ends -->

  	<!-- Main bar -->
  	<div class="mainbar">
      
	    <!-- Page heading -->
	    <div class="page-head">
        <!-- Page heading -->
	      <h2 class="pull-left"> 
          <!-- page meta -->
          <span class="page-meta">材料统计</span>
        </h2>


        <!-- Breadcrumb -->
        <div class="bread-crumb pull-right">
          
         
        </div>

        <div class="clearfix"></div>

	    </div>
	    <!-- Page heading ends -->



	    <!-- Matter -->

	    <div class="matter">
        <div class="container">

          <div class="row">

            <div class="col-md-12">


              <div class="widget wgreen">
                
                <div class="widget-head">
                  <div class="widget-icons pull-right">
                    <a href="#" class="wminimize"><i class="icon-chevron-up"></i></a> 
                    <a href="#" class="wclose"><i class="icon-remove"></i></a>
                  </div>
                  <div class="clearfix"></div>
                </div>

                <div class="widget-content">
                  <div class="padd">

                    <!-- Form starts.  -->
                     <form action="{:U('Index/material_export')}" method="get" class="form-horizontal" role="form"id="form1111">
                              
                      

                           <div class="form-group row">
                            <label class="col-lg-1 control-label">下单时间</label>
                            <div class="col-lg-3">  
                             <div id="datetimepicker1" class="input-append nianyueri">
                        <input data-format="yyyy-MM-dd" type="text" class="form-control dtpicker booking_time2"name="end_date" value="{:date('Y-m-d',time())}">
                        <span class="add-on">
                          <i data-time-icon="icon-time" data-date-icon="icon-calendar" class="btn btn-info btn-lg"></i>
                        </span>
                      </div>
                            </div>   
                          </div>
                          
                         
                      


                      <div class="form-group">
                        <div class="col-lg-9" style="margin-left:16px;">
                          <button type="button" class="btn btn-primary suosousuosou">搜索</button>
                          <button type="submit" class="btn btn-success derived">导出生成excel</button>
                        </div>
                      </div>

                <div class="form-group xianxianxianshi" >
                   <table class="table table-striped table-bordered table-hover">
                      <thead>
                        <tr>
                         <th>下单日期</th>
                         <th>商品名</th>
                         <th>餐类</th>
                         <th>材料名</th>
                         <th>数量</th>
                         <th>单位</th>
                        </tr>
                      </thead>
                      <tbody class="dddddd">
                    
                      <volist name="result" id="result">
                        <?php
                        $goodss =$goods[$result['id']];
                        $material =explode(',',$goodss['material']);
                        $material_number =explode(',',$goodss['material_number']);
                        $material_unit =explode(',',$goodss['material_unit']);
                        $o =count($material);

                        ?>
                        <tr>
                          <td rowspan="{$o}">{:date('Y-m-d',$result['sales_time'])}</td>
                          <td rowspan="{$o}">{$goodss.good_name}</td>
                          <td rowspan="{$o}"><if condition="$goodss['good_type'] eq 1">早餐<elseif condition="$goodss['good_type'] eq 2"/>午餐<elseif condition="$goodss['good_type'] eq 3"/>晚餐</if></td>
                          <for start="0" end="$o">
                          <td>{$material[$i]}</td>
                          <td><php> echo $material_number[$i]*$result['sales_amount']</php></td>
                          <td>{$material_unit[$i]}</td>
                        </tr>
                        </for>
                        <!-- <tr>
                          <td>adas</td>
                          <td>asddasd</td>
                        </tr>
                        <tr>
                          <td>adas</td>
                          <td>asddasd</td>
                        </tr> -->
                        </volist>
                      </tbody>
                    </table>
                  </div>
                  </form>

                  </div>
                </div>
                  <div class="widget-foot">
                    <!-- Footer goes here -->
                  </div>
              </div>  

            </div>

          </div>

        </div>
		  </div>

		<!-- Matter ends -->

    </div>

   <!-- Mainbar ends -->
   <div class="clearfix"></div>
   <script src="__JS__jquery-2.1.1.min.js"></script>
     <script type="text/javascript">
$(function(){

  $(document).on('click','.suosousuosou',function(){
    var end_date      =$('.booking_time2').val();
   $.ajax({
    type:"GET",
    url:"{:U('Index/material_statistics_ajax')}",
    data:{end_date:end_date},
    dataType:'json',
    success:function(data){
      var list =data.result;
      var dd='';
      for(var i=0 in list){
          var goodss =data.goods[list[i].id];
          var material = goodss.material.split(',');
          var material_number = goodss.material_number.split(',');
          var material_unit = goodss.material_unit.split(',');
          var o =material.length;
          dd +='<tr>';
          dd +='<td rowspan="'+o+'">'+getLocalTime(list[i].sales_time)+'</td>';
          dd +='<td rowspan="'+o+'">'+goodss.good_name+'</td>';
          if(goodss.good_type==1){
           dd +='<td rowspan="'+o+'">早餐</td>'; 
          }else if(goodss.good_type==2){
            dd +='<td rowspan="'+o+'">午餐</td>';
          }else if(goodss.good_type==3){
            dd +='<td rowspan="'+o+'">晚餐</td>';
          }
          for(var k=0;k<o;k++){
            dd +='<td>'+material[k]+'</td>';
            dd +='<td>'+material_number[k]*list[i].sales_amount+'</td>';
            dd +='<td>'+material_unit[k]+'</td>';
            dd +='</tr>';
          }
        dd +='</tr>';
      }
      $('.dddddd').html(dd);
    }
   })

  });
  function getLocalTime(nS) {
    var bb = new Date(parseInt(nS) * 1000).toLocaleString().substr(0,10);
    var reg = new RegExp("/","g");//g,表示全部替换。
    var aa =bb.replace(reg,"-");
    return aa;
} 
      
      });
</script>
</div>
<include file="public:footer"/>
