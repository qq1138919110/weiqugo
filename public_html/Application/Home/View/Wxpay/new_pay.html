<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <title>微信安全支付</title>
      <link href="__CSS__bootstrap.min.css" rel="stylesheet"/>
      <style>
		/* pay */
		.pay{
			width: 100%;
			background-color: #fff;
			padding: 8px 0;
		}
		.pay p{
			margin: 10px 10px;
			font-size: 16px;
		}
		.pay strong{
			color: #ff6666;
		}
		.btn{
			width: 80%;
			margin-left: 10%;
			margin-top: 60px;
			height: 40px;
		}
      </style>
<script>
	function onBridgeReady(){
	   WeixinJSBridge.invoke(
	       'getBrandWCPayRequest', 
	       <?php echo $jsApiParameters; ?>,
	       function(res){
	       	
	       //alert(res.err_code+res.err_desc+res.err_msg); 
	       WeixinJSBridge.log(res.err_msg);    
	           if(res.err_msg == "get_brand_wcpay_request:ok" ) {
	       		var order_id =document.getElementById('oooder').value;
	           	alert('支付成功');
	           	window.location.href="{:U('Personal/vip')}";
	           }     // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
	           else if(res.err_msg == "get_brand_wcpay_request:cancel"){
	       		var order_id =document.getElementById('oooder').value;
	           	alert('取消支付');
	           		window.location.href="{:U('Personal/vip')}";
	           }else{
	       		var order_id =document.getElementById('oooder').value;
	           	alert('服务器延迟，请刷新后再试');
	           	window.location.href="{:U('Personal/vip')}";
	           }
	       }
	   ); 
	}
	function callpay()
	{
		if (typeof WeixinJSBridge == "undefined"){
			   if( document.addEventListener ){
			       document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
			   }else if (document.attachEvent){
			       document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
			       document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
			   }
			}else{
			   onBridgeReady();
		}
	}	
</script>
 </head>
 <body style="background-color: #f9f9f9;">
 	<div class="pay">
 		<p>订单号：<span>{$order.order_id}</span></p>
 		<p>支付金额：<strong>￥{$order.price}</strong></p>
 	</div>
	<div>
        <button type="button" class="btn btn-danger" onclick="callpay()" >确定支付</button>
        <input type="hidden" id="oooder" value="{$order_id}">
    </div>
 </body>
 </html>
